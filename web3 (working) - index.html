<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
    <p>Testing Reading Balances</p>

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script>
        // Add a variable to keep track of the timeout
        window.timeoutID = null;

        window.showTopBar = function(message, duration = 20000) {
            let topBar = document.getElementById('myTopBar');
            topBar.innerHTML = message; // updated to innerHTML to support HTML tags in message
            topBar.classList.remove('d-none');

            // Clear any previous timeouts
            clearTimeout(window.timeoutID);

            // Set the new timeout
            window.timeoutID = setTimeout(() => {
                topBar.classList.add('d-none');
            }, duration);
        }

        // This script will be executed when the page loads
        window.addEventListener('load', async () => {
            // Modern dapp browsers...
            if (window.ethereum) {
                window.web3 = new Web3(ethereum);
                try {
                    // Request account access
                    await ethereum.request({ method: 'eth_requestAccounts' });

                    // If account changes, refresh the page
                    ethereum.on('accountsChanged', function() {
                        location.reload();
                    });

                    // If network changes, refresh the page
                    ethereum.on('chainChanged', function() {
                        location.reload();
                    });
                } catch (error) {
                    // User denied account access...
                    console.error("User denied account access")
                }
            }
            // Legacy dapp browsers...
            else if (window.web3) {
                // Use Mist/MetaMask's provider
                window.web3 = new Web3(web3.currentProvider);
            }
            // Non-Ethereum browser detected
            else {
                alert('Non-Ethereum browser detected. Please install MetaMask before proceeding!');
            }

            // For ERC20 balance fetch, you only need the balanceOf part of the ABI
            const ERC20_ABI = [{
                "constant": true,
                "inputs": [{ "name": "_owner", "type": "address" }],
                "name": "balanceOf",
                "outputs": [{ "name": "balance", "type": "uint256" }],
                "type": "function"
            }];

            const addressToCheck = "0x57631Cf3266B84fa91e54e41516961d9DfE63100"; // The address you want to check

            /////////////////////////////////////////////////////////////////////////////////////////////    
            // Avalanche C-Chain RPC endpoint (ensure it's CORS-enabled if hosted)
            const avalanche_rpc = "https://avalanche-mainnet.infura.io/v3/b5eb8c9c2143460ca474f9d37b5cdfde";
            
            const web3_avalanche = new Web3(new Web3.providers.HttpProvider(avalanche_rpc));


            // WETH Balance on Avalanche
            const weth_contract_address_avalanche = "0x49D5c2BdFfac6CE2BFdB6640F4F80f226bc10bAB";

            const wethContractAvalanche = new web3_avalanche.eth.Contract(ERC20_ABI, weth_contract_address_avalanche);

            wethContractAvalanche.methods.balanceOf(addressToCheck).call((err, result) => {
                if (err) {
                    console.error('Avalanche WETH Error:', err);
                } else {
                    const wethBalanceAvalanche = web3.utils.fromWei(result, 'ether'); 
                    console.log(`Avalanche WETH Balance: ${wethBalanceAvalanche}`);
                }
            });

        
            // Adjust for Avalanche USDT address if it's different
            const usdt_contract_address_avalanche = "0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7";
            
            const usdtContractAvalanche = new web3_avalanche.eth.Contract(ERC20_ABI, usdt_contract_address_avalanche);

            usdtContractAvalanche.methods.balanceOf(addressToCheck).call((err, result) => {
                if (err) {
                    console.error('Avalanche USDT Error:', err);
                } else {
                    const usdtBalanceAvalanche = web3.utils.fromWei(result, 'mwei'); 
                    console.log(`Avalanche USDT Balance: ${usdtBalanceAvalanche}`);
                }
            });
            ////////////////////////////////////////////////////////////

            // END OF AVALANCHE CODE

        });
    </script>
</head>

</html>
